DROP TABLE MENU_ITEM IF EXISTS;
DROP TABLE ROLE IF EXISTS;
DROP TABLE VOTE IF EXISTS;
DROP TABLE USER IF EXISTS;
DROP TABLE DISH IF EXISTS;
DROP TABLE RESTAURANT IF EXISTS;
DROP SEQUENCE GLOBAL_SEQ IF EXISTS;

CREATE SEQUENCE GLOBAL_SEQ AS BIGINT START WITH 100000000;

CREATE TABLE RESTAURANT
(
    id              BIGINT GENERATED BY DEFAULT AS SEQUENCE GLOBAL_SEQ PRIMARY KEY,
    name            VARCHAR(255)    NOT NULL
);

CREATE TABLE DISH
(
    id              BIGINT GENERATED BY DEFAULT AS SEQUENCE GLOBAL_SEQ PRIMARY KEY,
    name            VARCHAR(255)    NOT NULL
);

CREATE TABLE MENU_ITEM
(
    id              BIGINT GENERATED BY DEFAULT AS SEQUENCE GLOBAL_SEQ PRIMARY KEY,
    date            DATE            NOT NULL,
    restaurant_id   BIGINT          NOT NULL,
    dish_id         BIGINT          NOT NULL,
    price           DECIMAL(10, 2)  NOT NULL,
    FOREIGN KEY (restaurant_id) REFERENCES RESTAURANT (id) ON DELETE CASCADE,
    FOREIGN KEY (dish_id) REFERENCES DISH (id) ON DELETE CASCADE
);

CREATE INDEX price_date_dish_id_price_idx
    ON MENU_ITEM (date, dish_id, price);


CREATE TABLE USER
(
  id               BIGINT GENERATED BY DEFAULT AS SEQUENCE GLOBAL_SEQ PRIMARY KEY,
  name             VARCHAR(255)            NOT NULL,
  email            VARCHAR(255)            NOT NULL,
  password         VARCHAR(255)            NOT NULL,
);

CREATE UNIQUE INDEX users_unique_email_idx
  ON USER (email);

CREATE TABLE ROLE
(
  user_id       BIGINT NOT NULL,
  role          VARCHAR(255),
  CONSTRAINT user_role_idx UNIQUE (user_id, role),
  FOREIGN KEY (user_id) REFERENCES USER (id) ON DELETE CASCADE
);

CREATE TABLE VOTE
(
  id            BIGINT GENERATED BY DEFAULT AS SEQUENCE GLOBAL_SEQ PRIMARY KEY,
  date          DATE NOT NULL,
  time          TIME NOT NULL,
  user_id       BIGINT NOT NULL,
  restaurant_id BIGINT NOT NULL,
  CONSTRAINT user_id_idx UNIQUE (user_id, date),
  FOREIGN KEY (user_id) REFERENCES USER (id) ON DELETE CASCADE,
  FOREIGN KEY (restaurant_id) REFERENCES RESTAURANT (id) ON DELETE CASCADE
);

CREATE UNIQUE INDEX vote_unique_date_user_id_restaurant_id_idx
    ON VOTE (date, user_id, restaurant_id);
